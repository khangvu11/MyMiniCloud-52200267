<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Student Portal – MyMiniCloud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --card: #020e2e;
      --primary: #22c55e;
      --primary-soft: rgba(34, 197, 94, 0.07);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --accent: #38bdf8;
      --danger: #f97373;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020817 0, #020617 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      border-bottom: 1px solid var(--border);
      padding: 0.7rem 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(to right, rgba(15,23,42,0.95), rgba(2,6,23,0.98));
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
    }

    .brand-logo {
      width: 30px;
      height: 30px;
      border-radius: 0.85rem;
      background: radial-gradient(circle at 30% 20%, #4ade80, #22c55e 40%, #16a34a 60%, #15803d 100%);
      box-shadow:
        0 0 0 1px rgba(22, 163, 74, 0.18),
        0 0 16px rgba(34, 197, 94, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #022c22;
      font-size: 0.8rem;
      font-weight: 800;
    }

    .nav-links a {
      color: var(--muted);
      text-decoration: none;
      font-size: 0.85rem;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      border: 1px solid transparent;
      transition: 0.18s;
    }

    .nav-links a:hover {
      color: var(--text);
      border-color: rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.85);
    }

    main {
      flex: 1;
      max-width: 980px;
      margin: 1.75rem auto 2.5rem;
      padding: 0 1.25rem 3rem;
    }

    .heading {
      margin-bottom: 1.5rem;
    }

    .heading h1 {
      font-size: clamp(1.6rem, 2.2vw + 1rem, 2.1rem);
      margin-bottom: 0.3rem;
    }

    .heading p {
      font-size: 0.92rem;
      color: var(--muted);
      max-width: 40rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.9rem;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .pill {
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.95);
    }

    .pill code {
      font-size: 0.8rem;
      color: var(--accent);
    }

    .card {
      background: radial-gradient(circle at top left, rgba(148,163,184,0.15), transparent 55%),
                  var(--card);
      border-radius: 1.1rem;
      padding: 1rem 1rem 1.1rem;
      border: 1px solid rgba(31,41,55,0.9);
      box-shadow: 0 24px 80px rgba(15,23,42,0.95);
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.8rem;
      font-size: 0.84rem;
      color: var(--muted);
    }

    .toolbar-right {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.35rem 0.9rem;
      font-size: 0.84rem;
      cursor: pointer;
      background: var(--primary-soft);
      color: var(--primary);
      border: 1px solid rgba(34,197,94,0.55);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: 0.18s;
    }

    button:hover {
      background: rgba(34,197,94,0.17);
      box-shadow: 0 0 16px rgba(34, 197, 94, 0.4);
    }

    .status {
      font-size: 0.8rem;
    }

    .status.ok {
      color: var(--primary);
    }

    .status.error {
      color: var(--danger);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.35rem;
      font-size: 0.86rem;
      overflow: hidden;
      border-radius: 0.9rem;
      border: 1px solid rgba(31,41,55,0.9);
    }

    thead {
      background: rgba(15,23,42,0.95);
    }

    th, td {
      padding: 0.55rem 0.7rem;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: var(--muted);
      font-size: 0.8rem;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.7);
    }

    tbody tr:hover {
      background: rgba(30,64,175,0.4);
    }

    td strong {
      font-weight: 600;
    }

    .gpa-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(34,197,94,0.65);
      background: rgba(22,163,74,0.15);
      font-size: 0.78rem;
      color: var(--primary);
    }

    .empty {
      padding: 0.8rem 0.7rem;
      font-size: 0.86rem;
      color: var(--muted);
    }

    .error-box {
      margin-top: 0.75rem;
      border-radius: 0.8rem;
      padding: 0.55rem 0.7rem;
      font-size: 0.82rem;
      border: 1px solid rgba(248,113,113,0.7);
      background: rgba(127,29,29,0.35);
      color: #fecaca;
      display: none;
    }

    footer {
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 0.75rem;
      padding: 0.75rem 1.25rem 1rem;
      text-align: center;
      background: radial-gradient(circle at bottom, rgba(15,23,42,0.92), rgba(2,6,23,0.98));
    }

    footer code { color: var(--accent); }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-logo">MC</div>
    <div>
      Student Portal
      <div style="font-size:0.75rem;color:var(--muted);font-weight:400">
        MyMiniCloud – phần 3 &amp; 9 (Backend + Gateway)
      </div>
    </div>
  </div>
  <div class="nav-links">
    <a href="/">← Về trang chủ</a>
  </div>
</header>

<main>
  <section class="heading">
    <h1>Danh sách sinh viên</h1>
    <p>
      Dữ liệu được đọc từ <strong>application-backend-server</strong> (API
      <code>/student</code>) và được truy cập thông qua
      <strong>API Gateway</strong> ở route <code>/student/</code>.
    </p>
    <div class="pill-row">
      <div class="pill">Gateway: <code>api-gateway-proxy-server</code></div>
      <div class="pill">Backend: <code>application-backend-server:8081</code></div>
      <div class="pill">DB: <code>relational-database-server (MariaDB)</code></div>
    </div>
  </section>

  <section class="card">
    <div class="toolbar">
      <div>
        <strong>Student table</strong>
        <span style="color:var(--muted);font-size:0.8rem">
          – dữ liệu JSON từ <code>/student/</code> (qua gateway)
        </span>
      </div>
      <div class="toolbar-right">
        <button id="reloadBtn" type="button">
          ↻ Tải lại
        </button>
        <span id="status" class="status">Đang chờ tải dữ liệu…</span>
      </div>
    </div>

    <table>
      <thead>
      <tr>
        <th>ID</th>
        <th>Họ tên</th>
        <th>Ngành học</th>
        <th>GPA</th>
      </tr>
      </thead>
      <tbody id="studentBody">
      <tr>
        <td colspan="4" class="empty">Đang tải dữ liệu sinh viên…</td>
      </tr>
      </tbody>
    </table>

    <div id="errorBox" class="error-box"></div>
  </section>
</main>

<footer>
  Student UI sử dụng <code>fetch('/student/')</code> →
  API Gateway (Nginx) → <code>application-backend-server</code> →
  MariaDB. Đây là phần giao diện cho các mục 2–3–9 trong báo cáo.
</footer>

<script>
  const API_URL = "/student/";

  const tbody = document.getElementById("studentBody");
  const statusEl = document.getElementById("status");
  const errorBox = document.getElementById("errorBox");
  const reloadBtn = document.getElementById("reloadBtn");

  let ACCESS_TOKEN = null;

  // ===== 1. Kiểm tra token & role 'student' =====
  (function () {
    const token = localStorage.getItem("access_token");
    if (!token) {
      alert("Bạn phải đăng nhập trước!");
      window.location.href = "/login.html";
      return;
    }

    try {
      const payload = JSON.parse(atob(token.split(".")[1]));
      const roles = payload.realm_access?.roles || [];
      console.log("JWT roles:", roles);

      const REQUIRED_ROLE = "student";   // <-- tên role trong Keycloak

      if (!roles.includes(REQUIRED_ROLE)) {
        alert("Bạn không có quyền truy cập Student Portal!");
        window.location.href = "/";
        return;
      }

      // nếu qua được đây thì token + role đều OK
      ACCESS_TOKEN = token;
    } catch (e) {
      console.error("Lỗi khi decode token:", e);
      alert("Token không hợp lệ. Vui lòng đăng nhập lại.");
      localStorage.clear();
      window.location.href = "/login.html";
    }
  })();

  // ===== 2. Gọi API /student/ với Bearer token =====
  async function loadStudents() {
    statusEl.textContent = "Đang tải dữ liệu từ " + API_URL + " …";
    statusEl.className = "status";
    errorBox.style.display = "none";
    errorBox.textContent = "";

    try {
      const res = await fetch(API_URL, {
        headers: {
          "Accept": "application/json",
          "Authorization": "Bearer " + ACCESS_TOKEN
        }
      });

      if (!res.ok) {
        throw new Error("HTTP " + res.status + " " + res.statusText);
      }

      const data = await res.json();
      renderTable(Array.isArray(data) ? data : []);
      statusEl.textContent = "Đã tải " + (Array.isArray(data) ? data.length : 0) + " sinh viên.";
      statusEl.className = "status ok";
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Lỗi khi tải dữ liệu.";
      statusEl.className = "status error";

      errorBox.textContent =
        "Không gọi được API " + API_URL +
        ". Kiểm tra giúp mình: docker compose, route /student/ trong Nginx, " +
        "và backend application-backend-server. Chi tiết: " + err.message;
      errorBox.style.display = "block";

      tbody.innerHTML =
        '<tr><td colspan="4" class="empty">Không thể tải dữ liệu sinh viên.</td></tr>';
    }
  }

  function renderTable(students) {
    if (!students.length) {
      tbody.innerHTML =
        '<tr><td colspan="4" class="empty">Không có sinh viên nào trong danh sách.</td></tr>';
      return;
    }

    tbody.innerHTML = "";
    for (const s of students) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><strong>${s.id ?? ""}</strong></td>
        <td>${s.name ?? ""}</td>
        <td>${s.major ?? ""}</td>
        <td><span class="gpa-badge">${s.gpa ?? ""}</span></td>
      `;
      tbody.appendChild(tr);
    }
  }

  reloadBtn.addEventListener("click", loadStudents);

  // auto load on first open
  loadStudents();
</script>
</body>
</html>
